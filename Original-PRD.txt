Excellent â€” everything is now clear. Below is the **complete PRD** for **Tiferes Lâ€™Moshe**, structured for execution in Cursor and deployment on Vercel within 90 minutes.

---

# ğŸ§¾ Product Requirements Document

**Project:** Tiferes Lâ€™Moshe â€” Online Audio Discourse Archive
**Goal:** A fast, modern, searchable database of audio shiurim (discourses), with admin upload capabilities, filters, and timestamped topics.

---

## âš™ï¸ Tech Stack

| Layer               | Technology                        | Purpose                            |
| ------------------- | --------------------------------- | ---------------------------------- |
| **Frontend**        | Next.js (App Router) + TypeScript | UI and routing                     |
| **Styling**         | TailwindCSS with global variables | Design system, Flexbox-only layout |
| **Storage**         | Cloudflare R2                     | MP3 + image storage                |
| **Database/Auth**   | Supabase                          | Auth, metadata, topics, timestamps |
| **Email (Contact)** | Resend API                        | Contact form                       |
| **Hosting**         | Vercel                            | Production                         |
| **Versioning**      | GitHub                            | Source control                     |

---

## ğŸ—ï¸ Core Pages

| Route              | Purpose                                                                 |
| ------------------ | ----------------------------------------------------------------------- |
| `/`                | Homepage with featured audio, search + filter bar                       |
| `/shiur/[slug]`    | Audio detail page with description, timestamps, tags, image, and player |
| `/about`           | About the Shul and speaker                                              |
| `/donate`          | External donation link (placeholder)                                    |
| `/book`            | External buy link (placeholder)                                         |
| `/contact`         | Contact form powered by Resend                                          |
| `/admin`           | Login page                                                              |
| `/admin/dashboard` | Admin panel to upload/manage shiurim                                    |

---

## ğŸ§  Global UX / Layout Rules

* All **containers use Flexbox**, never CSS grid.
* All **colors and fonts** use global CSS variables.
* All **divs and major sections have descriptive class names** (`.navbar`, `.audio-card`, `.filter-bar`, `.admin-upload-form`, etc.).
* Page transitions fade in/out (via Framer Motion or Tailwind transitions).
* Sticky top navbar with Donate / Buy buttons.
* Mobile hamburger includes â€œNext Discourseâ€ widget at bottom.
* Use Lucide icons for all iconography

---

## ğŸ¨ Design System

### Global Variables (`globals.css`)

```css
:root {
  --color-bg: #ffffff;
  --color-text: #000000;
  --color-accent: #001f3f; /* deep navy */
  --color-hover: rgba(0,0,0,0.08);
  --font-main: 'Inter', sans-serif;
}
```

### Layout Tokens

* Padding: `p-4 md:p-6`
* Rounded corners: `rounded-2xl`
* Shadows: `shadow-md hover:shadow-lg`
* Flexbox default: `flex flex-col gap-4`

---

## ğŸ§© Component Map

### Global

* **Navbar**

  * Left: site title/logo
  * Center: navigation links (Home, About, Contact)
  * Right: `Donate` (outline black), `Buy Now` (filled black)
  * Mobile: hamburger expands to full list + Next Discourse at bottom
* **SearchBar**

  * Instant search with debounce (Supabase full-text search)
  * Filter: Topics (dropdown), Date range
* **AudioCard**

  * Title, description, tags, duration
  * â€œListenâ€ button opens `/shiur/[slug]`
* **AudioPlayer**

  * Standard scrub bar, play/pause, volume, timestamp display
  * Optional â€œDownloadâ€ if allowed
* **TimestampsList**

  * Renders `[topic, time]` pairs under audio player; clicking jumps to that time

### Pages

* **HomePage**

  * Hero: â€œTiferes Lâ€™Moshe Audio Discoursesâ€
  * Search bar + Filters
  * List of AudioCards
* **ShiurDetailPage**

  * Player + TimestampsList
  * Tags list + image
  * Description
* **About**

  * Image + rich text bio of speaker and Shul info
* **Contact**

  * Form (name, email, message â†’ Resend API)
* **AdminDashboard**

  * Upload form:

    * Title (text)
    * Description (textarea)
    * Tags (comma-separated)
    * Image upload (Cloudflare)
    * Audio file upload (Cloudflare)
    * Timestamp Topics (add/remove rows: `{topic, hh:mm:ss}`)
    * Toggle â€œAllow Downloadâ€
  * List existing shiurim with Edit/Delete

---

## ğŸ§® Supabase Schema

### `shiurim`

| Column           | Type        | Notes                                      |
| ---------------- | ----------- | ------------------------------------------ |
| `id`             | uuid        | Primary key                                |
| `slug`           | text        | URL slug                                   |
| `title`          | text        | Required                                   |
| `description`    | text        | Optional                                   |
| `tags`           | text[]      | For filters                                |
| `image_url`      | text        | Optional                                   |
| `audio_url`      | text        | Cloudflare link                            |
| `timestamps`     | jsonb       | Array of `{ topic: string, time: string }` |
| `allow_download` | boolean     | Default false                              |
| `created_at`     | timestamptz | Default now()                              |
| `updated_at`     | timestamptz | Auto-update trigger                        |
| `transcript`     | text        | Optional plain text                        |

### `discourse_schedule`

| Column            | Type        | Notes                    |
| ----------------- | ----------- | ------------------------ |
| `id`              | uuid        | Primary key              |
| `weekday`         | text        | e.g., â€œMondayâ€           |
| `time`            | text        | e.g., â€œ8PMâ€              |
| `location`        | text        | Optional                 |
| `next_occurrence` | timestamptz | Auto-generated next date |

### `admin_users`

| Column          | Type |
| --------------- | ---- |
| `email`         | text |
| `password_hash` | text |

---

## ğŸ§  TypeScript Interfaces

```ts
export interface TimestampTopic {
  topic: string;
  time: string; // HH:MM:SS
}

export interface Shiur {
  id: string;
  slug: string;
  title: string;
  description: string;
  tags: string[];
  image_url?: string;
  audio_url: string;
  timestamps?: TimestampTopic[];
  allow_download: boolean;
  transcript?: string;
  created_at: string;
}

export interface DiscourseSchedule {
  weekday: string;
  time: string;
  location?: string;
  next_occurrence: string;
}
```

---

## ğŸ” Auth & Admin Flow

* **Login** (email/password via Supabase Auth)
* **Dashboard**

  * Upload new shiur
  * Manage existing shiurim
  * Edit â€œNext Discourseâ€ schedule
* **Storage integration**

  * MP3 & image uploaded to Cloudflare R2 â†’ store public URL in Supabase
* Admin-only route guard with middleware (`middleware.ts` + Supabase session check)

---

## ğŸ” Search & Filter Logic

* **Instant search (debounced 300ms)** querying:

  * title, description, tags, topics, transcript
* **Filters**

  * Topic dropdown (auto-filled from all timestampsâ€™ topics)
  * Date range picker
* **Sorting**

  * Default: newest first

---

## ğŸ’° Donate & Buy Buttons

* `Donate` â†’ `/donate` â†’ placeholder external link
* `Buy Now` â†’ `/book` â†’ placeholder external link
* Both styled as `rounded-lg font-semibold border border-black px-4 py-2 hover:bg-black hover:text-white transition`

---

## ğŸ•’ Floating Discourse Container

**Location:** bottom of hamburger menu
**Content:**

> Next Discourse: Monday, 8PM @ [location]

Auto-populates from `discourse_schedule` entry; updates weekly.

---

## ğŸ§¾ Contact Form (Resend)

**Endpoint:** `/api/contact`
**POST** `{ name, email, message }`
â†’ sends email via Resend API to [admin@tifereslmoshe.org](mailto:admin@tifereslmoshe.org)
Response: 200 on success, 400 on fail

---

## ğŸš€ Deployment Workflow

1. Build project in **Cursor**
2. Connect **Supabase project** + `.env` with credentials
3. Configure **Cloudflare R2** + Access Keys
4. Add **Resend API Key** to environment
5. Push to **GitHub**, deploy to **Vercel**

---

## âŒ¨ï¸ Folder Structure

```
/src
 â”œâ”€ app/
 â”‚   â”œâ”€ page.tsx
 â”‚   â”œâ”€ shiur/[slug]/page.tsx
 â”‚   â”œâ”€ about/page.tsx
 â”‚   â”œâ”€ contact/page.tsx
 â”‚   â”œâ”€ donate/page.tsx
 â”‚   â”œâ”€ book/page.tsx
 â”‚   â””â”€ admin/
 â”‚       â”œâ”€ page.tsx
 â”‚       â””â”€ dashboard/page.tsx
 â”œâ”€ components/
 â”‚   â”œâ”€ Navbar.tsx
 â”‚   â”œâ”€ SearchBar.tsx
 â”‚   â”œâ”€ AudioCard.tsx
 â”‚   â”œâ”€ AudioPlayer.tsx
 â”‚   â”œâ”€ TimestampsList.tsx
 â”‚   â”œâ”€ DiscourseWidget.tsx
 â”‚   â””â”€ AdminForm.tsx
 â”œâ”€ lib/
 â”‚   â”œâ”€ supabaseClient.ts
 â”‚   â”œâ”€ cloudflareUpload.ts
 â”‚   â”œâ”€ resendEmail.ts
 â”‚   â””â”€ auth.ts
 â”œâ”€ styles/
 â”‚   â”œâ”€ globals.css
 â”‚   â””â”€ variables.css
```

---

## ğŸ§© Key Implementation Notes

* **Flexbox everywhere** (`flex flex-col` or `flex-row` as needed)
* **All component divs named** (`<div className="audio-card">`)
* **Tailwind global color tokens** only; local overrides in rare exceptions
* **Slug auto-generation** from title in admin form
* **Audio timestamps clickable** â†’ `audioRef.current.currentTime = parsedSeconds(time)`
* **Instant search** â†’ client-side fetch from Supabase via Edge Function